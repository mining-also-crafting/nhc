import{IS_HIDPI,IS_RTL}from"./constants.js";import{getTimeStamp}from"./utils.js";class DistanceMeter{constructor(canvas,spritePos,canvasWidth){this.canvas=canvas,this.canvasCtx=canvas.getContext("2d"),this.image=window.Runner.imageSprite,this.spritePos=spritePos,this.x=0,this.y=5,this.currentDistance=0,this.maxScore=0,this.highScore="0",this.container=null,this.digits=[],this.achievement=!1,this.defaultString="",this.flashTimer=0,this.flashIterations=0,this.invertTrigger=!1,this.flashingRafId=null,this.highScoreBounds={},this.highScoreFlashing=!1,this.config=DistanceMeter.config,this.maxScoreUnits=this.config.MAX_DISTANCE_UNITS,this.canvasWidth=canvasWidth,this.init(canvasWidth)}init(width){let maxDistanceStr="";this.calcXPos(width),this.maxScore=this.maxScoreUnits;for(let i=0;i<this.maxScoreUnits;i++)this.draw(i,0),this.defaultString+="0",maxDistanceStr+="9";this.maxScore=parseInt(maxDistanceStr,10)}calcXPos(canvasWidth){this.x=canvasWidth-DistanceMeter.dimensions.DEST_WIDTH*(this.maxScoreUnits+1)}draw(digitPos,value,opt_highScore){let sourceWidth=DistanceMeter.dimensions.WIDTH,sourceHeight=DistanceMeter.dimensions.HEIGHT,sourceX=DistanceMeter.dimensions.WIDTH*value;var highScoreX,value=0,digitPos=digitPos*DistanceMeter.dimensions.DEST_WIDTH,targetY=this.y,targetWidth=DistanceMeter.dimensions.WIDTH,targetHeight=DistanceMeter.dimensions.HEIGHT;IS_HIDPI&&(sourceWidth*=2,sourceHeight*=2,sourceX*=2),sourceX+=this.spritePos.x,value+=this.spritePos.y,this.canvasCtx.save(),IS_RTL?(opt_highScore?this.canvasCtx.translate(this.canvasWidth-DistanceMeter.dimensions.WIDTH*(this.maxScoreUnits+3),this.y):this.canvasCtx.translate(this.canvasWidth-DistanceMeter.dimensions.WIDTH,this.y),this.canvasCtx.scale(-1,1)):(highScoreX=this.x-2*this.maxScoreUnits*DistanceMeter.dimensions.WIDTH,opt_highScore?this.canvasCtx.translate(highScoreX,this.y):this.canvasCtx.translate(this.x,this.y)),this.canvasCtx.drawImage(this.image,sourceX,value,sourceWidth,sourceHeight,digitPos,targetY,targetWidth,targetHeight),this.canvasCtx.restore()}getActualDistance(distance){return distance?Math.round(distance*this.config.COEFFICIENT):0}update(deltaTime,distance){let paint=!0,playSound=!1;if(this.achievement?this.flashIterations<=this.config.FLASH_ITERATIONS?(this.flashTimer+=deltaTime,this.flashTimer<this.config.FLASH_DURATION?paint=!1:this.flashTimer>2*this.config.FLASH_DURATION&&(this.flashTimer=0,this.flashIterations++)):(this.achievement=!1,this.flashIterations=0,this.flashTimer=0):((distance=this.getActualDistance(distance))>this.maxScore&&this.maxScoreUnits===this.config.MAX_DISTANCE_UNITS?(this.maxScoreUnits++,this.maxScore=parseInt(this.maxScore+"9",10)):this.distance=0,0<distance?(distance%this.config.ACHIEVEMENT_DISTANCE==0&&(this.achievement=!0,this.flashTimer=0,playSound=!0),deltaTime=(this.defaultString+distance).substr(-this.maxScoreUnits),this.digits=deltaTime.split("")):this.digits=this.defaultString.split("")),paint)for(let i=this.digits.length-1;0<=i;i--)this.draw(i,parseInt(this.digits[i],10));return this.drawHighScore(),playSound}drawHighScore(){if(0<parseInt(this.highScore,10)){this.canvasCtx.save(),this.canvasCtx.globalAlpha=.8;for(let i=this.highScore.length-1;0<=i;i--)this.draw(i,parseInt(this.highScore[i],10),!0);this.canvasCtx.restore()}}setHighScore(distance){distance=this.getActualDistance(distance);distance=(this.defaultString+distance).substr(-this.maxScoreUnits);this.highScore=["10","11",""].concat(distance.split(""))}hasClickedOnHighScore(e){let x=0,y=0;var canvasBounds;return y=e.touches?(canvasBounds=this.canvas.getBoundingClientRect(),x=e.touches[0].clientX-canvasBounds.left,e.touches[0].clientY-canvasBounds.top):(x=e.offsetX,e.offsetY),this.highScoreBounds=this.getHighScoreBounds(),x>=this.highScoreBounds.x&&x<=this.highScoreBounds.x+this.highScoreBounds.width&&y>=this.highScoreBounds.y&&y<=this.highScoreBounds.y+this.highScoreBounds.height}getHighScoreBounds(){return{x:this.x-2*this.maxScoreUnits*DistanceMeter.dimensions.WIDTH-DistanceMeter.config.HIGH_SCORE_HIT_AREA_PADDING,y:this.y,width:DistanceMeter.dimensions.WIDTH*(this.highScore.length+1)+DistanceMeter.config.HIGH_SCORE_HIT_AREA_PADDING,height:DistanceMeter.dimensions.HEIGHT+2*DistanceMeter.config.HIGH_SCORE_HIT_AREA_PADDING}}flashHighScore(){var now=getTimeStamp(),deltaTime=now-(this.frameTimeStamp||now);let paint=!0;this.frameTimeStamp=now,this.flashIterations>2*this.config.FLASH_ITERATIONS?this.cancelHighScoreFlashing():(this.flashTimer+=deltaTime,this.flashTimer<this.config.FLASH_DURATION?paint=!1:this.flashTimer>2*this.config.FLASH_DURATION&&(this.flashTimer=0,this.flashIterations++),paint?this.drawHighScore():this.clearHighScoreBounds(),this.flashingRafId=requestAnimationFrame(this.flashHighScore.bind(this)))}clearHighScoreBounds(){this.canvasCtx.save(),this.canvasCtx.fillStyle="#fff",this.canvasCtx.rect(this.highScoreBounds.x,this.highScoreBounds.y,this.highScoreBounds.width,this.highScoreBounds.height),this.canvasCtx.fill(),this.canvasCtx.restore()}startHighScoreFlashing(){this.highScoreFlashing=!0,this.flashHighScore()}isHighScoreFlashing(){return this.highScoreFlashing}cancelHighScoreFlashing(){this.flashingRafId&&cancelAnimationFrame(this.flashingRafId),this.flashIterations=0,this.flashTimer=0,this.highScoreFlashing=!1,this.clearHighScoreBounds(),this.drawHighScore()}resetHighScore(){this.setHighScore(0),this.cancelHighScoreFlashing()}reset(){this.update(0,0),this.achievement=!1}}DistanceMeter.dimensions={WIDTH:10,HEIGHT:13,DEST_WIDTH:11},DistanceMeter.yPos=[0,13,27,40,53,67,80,93,107,120],DistanceMeter.config={MAX_DISTANCE_UNITS:5,ACHIEVEMENT_DISTANCE:100,COEFFICIENT:.025,FLASH_DURATION:250,FLASH_ITERATIONS:3,HIGH_SCORE_HIT_AREA_PADDING:4};export{DistanceMeter};