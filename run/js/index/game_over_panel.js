import{IS_HIDPI,IS_RTL}from"./constants.js";import{spriteDefinitionByType}from"./offline-sprite-definitions.js";import{getTimeStamp}from"./utils.js";class GameOverPanel{constructor(canvas,textImgPos,restartImgPos,dimensions,opt_altGameEndImgPos,opt_altGameActive){this.canvas=canvas,this.canvasCtx=canvas.getContext("2d"),this.canvasDimensions=dimensions,this.textImgPos=textImgPos,this.restartImgPos=restartImgPos,this.altGameEndImgPos=opt_altGameEndImgPos,this.altGameModeActive=opt_altGameActive,this.frameTimeStamp=0,this.animTimer=0,this.currentFrame=0,this.gameOverRafId=null,this.flashTimer=0,this.flashCounter=0,this.originalText=!0}updateDimensions(width,opt_height){this.canvasDimensions.WIDTH=width,opt_height&&(this.canvasDimensions.HEIGHT=opt_height),this.currentFrame=GameOverPanel.animConfig.frames.length-1}drawGameOverText(dimensions,opt_useAltText){var centerX=this.canvasDimensions.WIDTH/2;let textSourceX=dimensions.TEXT_X,textSourceY=dimensions.TEXT_Y,textSourceWidth=dimensions.TEXT_WIDTH,textSourceHeight=dimensions.TEXT_HEIGHT;var centerX=Math.round(centerX-dimensions.TEXT_WIDTH/2),textTargetY=Math.round((this.canvasDimensions.HEIGHT-25)/3),textTargetWidth=dimensions.TEXT_WIDTH,dimensions=dimensions.TEXT_HEIGHT,opt_useAltText=(IS_HIDPI&&(textSourceY*=2,textSourceX*=2,textSourceWidth*=2,textSourceHeight*=2),opt_useAltText||(textSourceX+=this.textImgPos.x,textSourceY+=this.textImgPos.y),opt_useAltText?window.Runner.altCommonImageSprite:window.Runner.origImageSprite);this.canvasCtx.save(),IS_RTL&&(this.canvasCtx.translate(this.canvasDimensions.WIDTH,0),this.canvasCtx.scale(-1,1)),this.canvasCtx.drawImage(opt_useAltText,textSourceX,textSourceY,textSourceWidth,textSourceHeight,centerX,textTargetY,textTargetWidth,dimensions),this.canvasCtx.restore()}drawAltGameElements(tRex){if(this.altGameModeActive&&window.Runner.spriteDefinition.ALT_GAME_END_CONFIG){var altGameEndConfig=window.Runner.spriteDefinition.ALT_GAME_END_CONFIG;let altGameEndSourceWidth=altGameEndConfig.WIDTH,altGameEndSourceHeight=altGameEndConfig.HEIGHT;var altGameEndTargetX=tRex.xPos+altGameEndConfig.X_OFFSET;IS_HIDPI&&(altGameEndSourceWidth*=2,altGameEndSourceHeight*=2),this.canvasCtx.drawImage(window.Runner.altCommonImageSprite,this.altGameEndImgPos.x,this.altGameEndImgPos.y,altGameEndSourceWidth,altGameEndSourceHeight,altGameEndTargetX,tRex.yPos+altGameEndConfig.Y_OFFSET,altGameEndConfig.WIDTH,altGameEndConfig.HEIGHT)}}drawRestartButton(){var dimensions=GameOverPanel.dimensions;let framePosX=GameOverPanel.animConfig.frames[this.currentFrame],restartSourceWidth=dimensions.RESTART_WIDTH,restartSourceHeight=dimensions.RESTART_HEIGHT;var restartTargetX=this.canvasDimensions.WIDTH/2-dimensions.RESTART_WIDTH/2,restartTargetY=this.canvasDimensions.HEIGHT/2;IS_HIDPI&&(restartSourceWidth*=2,restartSourceHeight*=2,framePosX*=2),this.canvasCtx.save(),IS_RTL&&(this.canvasCtx.translate(this.canvasDimensions.WIDTH,0),this.canvasCtx.scale(-1,1)),this.canvasCtx.drawImage(window.Runner.origImageSprite,this.restartImgPos.x+framePosX,this.restartImgPos.y,restartSourceWidth,restartSourceHeight,restartTargetX,restartTargetY,dimensions.RESTART_WIDTH,dimensions.RESTART_HEIGHT),this.canvasCtx.restore()}draw(opt_altGameModeActive,opt_tRex){opt_altGameModeActive&&(this.altGameModeActive=opt_altGameModeActive),this.drawGameOverText(GameOverPanel.dimensions,!1),this.drawRestartButton(),this.drawAltGameElements(opt_tRex),this.update()}update(){var now=getTimeStamp(),deltaTime=now-(this.frameTimeStamp||now);if(this.frameTimeStamp=now,this.animTimer+=deltaTime,this.flashTimer+=deltaTime,0===this.currentFrame&&this.animTimer>GameOverPanel.LOGO_PAUSE_DURATION)this.animTimer=0,this.currentFrame++,this.drawRestartButton();else if(0<this.currentFrame&&this.currentFrame<GameOverPanel.animConfig.frames.length)this.animTimer>=GameOverPanel.animConfig.msPerFrame&&(this.currentFrame++,this.drawRestartButton());else if(!this.altGameModeActive&&this.currentFrame===GameOverPanel.animConfig.frames.length)return void this.reset();if(this.altGameModeActive&&spriteDefinitionByType.original.ALT_GAME_OVER_TEXT_CONFIG){now=spriteDefinitionByType.original.ALT_GAME_OVER_TEXT_CONFIG;if(now.FLASHING){if(this.flashCounter<GameOverPanel.FLASH_ITERATIONS&&this.flashTimer>now.FLASH_DURATION)this.flashTimer=0,this.originalText=!this.originalText,this.clearGameOverTextBounds(),this.originalText?(this.drawGameOverText(GameOverPanel.dimensions,!1),this.flashCounter++):this.drawGameOverText(now,!0);else if(this.flashCounter>=GameOverPanel.FLASH_ITERATIONS)return void this.reset()}else this.clearGameOverTextBounds(now),this.drawGameOverText(now,!0)}this.gameOverRafId=requestAnimationFrame(this.update.bind(this))}clearGameOverTextBounds(dimensions){this.canvasCtx.save(),this.canvasCtx.clearRect(Math.round(this.canvasDimensions.WIDTH/2-dimensions.TEXT_WIDTH/2),Math.round((this.canvasDimensions.HEIGHT-25)/3),dimensions.TEXT_WIDTH,dimensions.TEXT_HEIGHT+4),this.canvasCtx.restore()}reset(){this.gameOverRafId&&(cancelAnimationFrame(this.gameOverRafId),this.gameOverRafId=null),this.animTimer=0,this.frameTimeStamp=0,this.currentFrame=0,this.flashTimer=0,this.flashCounter=0,this.originalText=!0}}GameOverPanel.RESTART_ANIM_DURATION=875,GameOverPanel.LOGO_PAUSE_DURATION=875,GameOverPanel.FLASH_ITERATIONS=5,GameOverPanel.animConfig={frames:[0,36,72,108,144,180,216,252],msPerFrame:GameOverPanel.RESTART_ANIM_DURATION/8},GameOverPanel.dimensions={TEXT_X:0,TEXT_Y:13,TEXT_WIDTH:191,TEXT_HEIGHT:11,RESTART_WIDTH:36,RESTART_HEIGHT:32};export{GameOverPanel};