import{BackgroundEl}from"./background_el.js";import{Cloud}from"./cloud.js";import{HorizonLine}from"./horizon_line.js";import{NightMode}from"./night_mode.js";import{Obstacle}from"./obstacle.js";import{spriteDefinitionByType}from"./offline-sprite-definitions.js";import{getRandomNum}from"./utils.js";class Horizon{constructor(canvas,spritePos,dimensions,gapCoefficient){this.canvas=canvas,this.canvasCtx=this.canvas.getContext("2d"),this.config=Horizon.config,this.dimensions=dimensions,this.gapCoefficient=gapCoefficient,this.obstacles=[],this.obstacleHistory=[],this.horizonOffsets=[0,0],this.cloudFrequency=this.config.CLOUD_FREQUENCY,this.spritePos=spritePos,this.nightMode=null,this.altGameModeActive=!1,this.clouds=[],this.cloudSpeed=this.config.BG_CLOUD_SPEED,this.backgroundEls=[],this.lastEl=null,this.backgroundSpeed=this.config.BG_CLOUD_SPEED,this.horizonLine=null,this.horizonLines=[],this.init()}init(){Obstacle.types=spriteDefinitionByType.original.OBSTACLES,this.addCloud();for(let i=0;i<window.Runner.spriteDefinition.LINES.length;i++)this.horizonLines.push(new HorizonLine(this.canvas,window.Runner.spriteDefinition.LINES[i]));this.nightMode=new NightMode(this.canvas,this.spritePos.MOON,this.dimensions.WIDTH)}adjustObstacleSpeed(){for(let i=0;i<Obstacle.types.length;i++)window.Runner.slowDown&&(Obstacle.types[i].multipleSpeed=Obstacle.types[i].multipleSpeed/2,Obstacle.types[i].minGap*=1.5,Obstacle.types[i].minSpeed=Obstacle.types[i].minSpeed/2,"object"==typeof Obstacle.types[i].yPos)&&(Obstacle.types[i].yPos=Obstacle.types[i].yPos[0],Obstacle.types[i].yPosMobile=Obstacle.types[i].yPos[0])}enableAltGameMode(spritePos){this.clouds=[],this.backgroundEls=[],this.altGameModeActive=!0,this.spritePos=spritePos,Obstacle.types=window.Runner.spriteDefinition.OBSTACLES,this.adjustObstacleSpeed(),Obstacle.MAX_GAP_COEFFICIENT=window.Runner.spriteDefinition.MAX_GAP_COEFFICIENT,Obstacle.MAX_OBSTACLE_LENGTH=window.Runner.spriteDefinition.MAX_OBSTACLE_LENGTH,BackgroundEl.config=window.Runner.spriteDefinition.BACKGROUND_EL_CONFIG,this.horizonLines=[];for(let i=0;i<window.Runner.spriteDefinition.LINES.length;i++)this.horizonLines.push(new HorizonLine(this.canvas,window.Runner.spriteDefinition.LINES[i]));this.reset()}update(deltaTime,currentSpeed,updateObstacles,showNightMode){this.runningTime+=deltaTime,this.altGameModeActive&&this.updateBackgroundEls(deltaTime,currentSpeed);for(let i=0;i<this.horizonLines.length;i++)this.horizonLines[i].update(deltaTime,currentSpeed);this.altGameModeActive&&!window.Runner.spriteDefinition.HAS_CLOUDS||(this.nightMode.update(showNightMode),this.updateClouds(deltaTime,currentSpeed)),updateObstacles&&this.updateObstacles(deltaTime,currentSpeed)}updateBackgroundEl(elSpeed,bgElArray,maxBgEl,bgElAddFunction,frequency){var numElements=bgElArray.length;if(numElements){for(let i=numElements-1;0<=i;i--)bgElArray[i].update(elSpeed);var lastEl=bgElArray[numElements-1];numElements<maxBgEl&&this.dimensions.WIDTH-lastEl.xPos>lastEl.gap&&frequency>Math.random()&&bgElAddFunction()}else bgElAddFunction()}updateClouds(deltaTime,speed){deltaTime=this.cloudSpeed/1e3*deltaTime*speed;this.updateBackgroundEl(deltaTime,this.clouds,this.config.MAX_CLOUDS,this.addCloud.bind(this),this.cloudFrequency),this.clouds=this.clouds.filter(obj=>!obj.remove)}updateBackgroundEls(deltaTime,speed){this.updateBackgroundEl(deltaTime,this.backgroundEls,BackgroundEl.config.MAX_BG_ELS,this.addBackgroundEl.bind(this),this.cloudFrequency),this.backgroundEls=this.backgroundEls.filter(obj=>!obj.remove)}updateObstacles(deltaTime,currentSpeed){var lastObstacle,updatedObstacles=this.obstacles.slice(0);for(let i=0;i<this.obstacles.length;i++){var obstacle=this.obstacles[i];obstacle.update(deltaTime,currentSpeed),obstacle.remove&&updatedObstacles.shift()}this.obstacles=updatedObstacles,0<this.obstacles.length?(lastObstacle=this.obstacles[this.obstacles.length-1])&&!lastObstacle.followingObstacleCreated&&lastObstacle.isVisible()&&lastObstacle.xPos+lastObstacle.width+lastObstacle.gap<this.dimensions.WIDTH&&(this.addNewObstacle(currentSpeed),lastObstacle.followingObstacleCreated=!0):this.addNewObstacle(currentSpeed)}removeFirstObstacle(){this.obstacles.shift()}addNewObstacle(currentSpeed){var obstacleCount="COLLECTABLE"!==Obstacle.types[Obstacle.types.length-1].type||window.Runner.isAltGameModeEnabled()&&!this.altGameModeActive||this.altGameModeActive?Obstacle.types.length-1:Obstacle.types.length-2,obstacleTypeIndex=0<obstacleCount?getRandomNum(0,obstacleCount):0,obstacleTypeIndex=Obstacle.types[obstacleTypeIndex];0<obstacleCount&&this.duplicateObstacleCheck(obstacleTypeIndex.type)||currentSpeed<obstacleTypeIndex.minSpeed?this.addNewObstacle(currentSpeed):(obstacleCount=this.spritePos[obstacleTypeIndex.type],this.obstacles.push(new Obstacle(this.canvasCtx,obstacleTypeIndex,obstacleCount,this.dimensions,this.gapCoefficient,currentSpeed,obstacleTypeIndex.width,this.altGameModeActive)),this.obstacleHistory.unshift(obstacleTypeIndex.type),1<this.obstacleHistory.length&&this.obstacleHistory.splice(window.Runner.config.MAX_OBSTACLE_DUPLICATION))}duplicateObstacleCheck(nextObstacleType){let duplicateCount=0;for(let i=0;i<this.obstacleHistory.length;i++)duplicateCount=this.obstacleHistory[i]===nextObstacleType?duplicateCount+1:0;return duplicateCount>=window.Runner.config.MAX_OBSTACLE_DUPLICATION}reset(){this.obstacles=[];for(let l=0;l<this.horizonLines.length;l++)this.horizonLines[l].reset();this.nightMode.reset()}resize(width,height){this.canvas.width=width,this.canvas.height=height}addCloud(){this.clouds.push(new Cloud(this.canvas,this.spritePos.CLOUD,this.dimensions.WIDTH))}addBackgroundEl(){var index,backgroundElTypes=Object.keys(window.Runner.spriteDefinition.BACKGROUND_EL);if(0<backgroundElTypes.length){let type=backgroundElTypes[getRandomNum(0,backgroundElTypes.length-1)];for(;type===this.lastEl&&1<backgroundElTypes.length;)index=getRandomNum(0,backgroundElTypes.length-1),type=backgroundElTypes[index];this.lastEl=type,this.backgroundEls.push(new BackgroundEl(this.canvas,this.spritePos.BACKGROUND_EL,this.dimensions.WIDTH,type))}}}Horizon.config={BG_CLOUD_SPEED:.2,BUMPY_THRESHOLD:.3,CLOUD_FREQUENCY:.5,HORIZON_HEIGHT:16,MAX_CLOUDS:6};export{Horizon};