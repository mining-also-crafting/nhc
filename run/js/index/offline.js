import{HIDDEN_CLASS}from"../constants.js";import{FPS,IS_HIDPI,IS_IOS,IS_MOBILE,IS_RTL}from"./constants.js";import{DistanceMeter}from"./distance_meter.js";import{GameOverPanel}from"./game_over_panel.js";import{GeneratedSoundFx}from"./generated_sound_fx.js";import{Horizon}from"./horizon.js";import{Obstacle}from"./obstacle.js";import{CollisionBox,GAME_TYPE,spriteDefinitionByType}from"./offline-sprite-definitions.js";import{Trex}from"./trex.js";import{getTimeStamp}from"./utils.js";let DEFAULT_WIDTH=600,ARCADE_MODE_URL="chrome://dino/",RESOURCE_POSTFIX="offline-resources-",A11Y_STRINGS={ariaLabel:"dinoGameA11yAriaLabel",description:"dinoGameA11yDescription",gameOver:"dinoGameA11yGameOver",highScore:"dinoGameA11yHighScore",jump:"dinoGameA11yJump",started:"dinoGameA11yStartGame",speedLabel:"dinoGameA11ySpeedToggle"},loadTimeData=void 0;class Runner{static config={AUDIOCUE_PROXIMITY_THRESHOLD:190,AUDIOCUE_PROXIMITY_THRESHOLD_MOBILE_A11Y:250,BG_CLOUD_SPEED:.2,BOTTOM_PAD:10,CANVAS_IN_VIEW_OFFSET:-10,CLEAR_TIME:3e3,CLOUD_FREQUENCY:.5,FADE_DURATION:1,FLASH_DURATION:1e3,GAMEOVER_CLEAR_TIME:1200,INITIAL_JUMP_VELOCITY:12,INVERT_FADE_DURATION:12e3,MAX_BLINK_COUNT:3,MAX_CLOUDS:6,MAX_OBSTACLE_LENGTH:3,MAX_OBSTACLE_DUPLICATION:2,RESOURCE_TEMPLATE_ID:"audio-resources",SPEED:6,SPEED_DROP_COEFFICIENT:3,ARCADE_MODE_INITIAL_TOP_POSITION:35,ARCADE_MODE_TOP_POSITION_PERCENT:.1};static normalConfig={ACCELERATION:.001,AUDIOCUE_PROXIMITY_THRESHOLD:190,AUDIOCUE_PROXIMITY_THRESHOLD_MOBILE_A11Y:250,GAP_COEFFICIENT:.6,INVERT_DISTANCE:700,MAX_SPEED:13,MOBILE_SPEED_COEFFICIENT:1.2,SPEED:6};static slowConfig={ACCELERATION:5e-4,AUDIOCUE_PROXIMITY_THRESHOLD:170,AUDIOCUE_PROXIMITY_THRESHOLD_MOBILE_A11Y:220,GAP_COEFFICIENT:.3,INVERT_DISTANCE:350,MAX_SPEED:9,MOBILE_SPEED_COEFFICIENT:1.5,SPEED:4.2};static defaultDimensions={WIDTH:DEFAULT_WIDTH,HEIGHT:150};static classes={ARCADE_MODE:"arcade-mode",CANVAS:"runner-canvas",CONTAINER:"runner-container",CRASHED:"crashed",ICON:"icon-offline",INVERTED:"inverted",SNACKBAR:"snackbar",SNACKBAR_SHOW:"snackbar-show",TOUCH_CONTROLLER:"controller"};static sounds={BUTTON_PRESS:"offline-sound-press",HIT:"offline-sound-hit",SCORE:"offline-sound-reached"};static keycodes={JUMP:{38:1,32:1},DUCK:{40:1},RESTART:{13:1}};static events={ANIM_END:"webkitAnimationEnd",CLICK:"click",KEYDOWN:"keydown",KEYUP:"keyup",POINTERDOWN:"pointerdown",POINTERUP:"pointerup",RESIZE:"resize",TOUCHEND:"touchend",TOUCHSTART:"touchstart",VISIBILITY:"visibilitychange",BLUR:"blur",FOCUS:"focus",LOAD:"load",GAMEPADCONNECTED:"gamepadconnected"};static updateCanvasScaling=function(canvas,opt_width,opt_height){var context=canvas.getContext("2d"),devicePixelRatio=Math.floor(window.devicePixelRatio)||1,backingStoreRatio=Math.floor(context.webkitBackingStorePixelRatio)||1,ratio=devicePixelRatio/backingStoreRatio;return devicePixelRatio!==backingStoreRatio?(backingStoreRatio=opt_width||canvas.width,opt_width=opt_height||canvas.height,canvas.width=backingStoreRatio*ratio,canvas.height=opt_width*ratio,canvas.style.width=backingStoreRatio+"px",canvas.style.height=opt_width+"px",context.scale(ratio,ratio),!0):(1===devicePixelRatio&&(canvas.style.width=canvas.width+"px",canvas.style.height=canvas.height+"px"),!1)};static isAltGameModeEnabled=function(){return loadTimeData&&loadTimeData.valueExists("enableAltGameMode")};constructor(outerContainerEl,opt_config){this.outerContainerEl=outerContainerEl,this.containerEl=null,this.snackbarEl=null,this.touchController=null,this.config=opt_config||Object.assign(Runner.config,Runner.normalConfig),this.dimensions=Runner.defaultDimensions,this.gameType=null,Runner.spriteDefinition=spriteDefinitionByType.original,this.altGameImageSprite=null,this.altGameModeActive=!1,this.altGameModeFlashTimer=null,this.fadeInTimer=0,this.canvas=null,this.canvasCtx=null,this.tRex=null,this.distanceMeter=null,this.distanceRan=0,this.highestScore=0,this.syncHighestScore=!1,this.time=0,this.runningTime=0,this.msPerFrame=1e3/FPS,this.currentSpeed=this.config.SPEED,Runner.slowDown=!1,this.obstacles=[],this.activated=!1,this.playing=!1,this.crashed=!1,this.paused=!1,this.inverted=!1,this.invertTimer=0,this.resizeTimerId_=null,this.playCount=0,this.audioBuffer=null,this.soundFx={},this.generatedSoundFx=null,this.audioContext=null,this.images={},this.imagesLoaded=0,this.pollingGamepads=!1,this.gamepadIndex=void 0,this.previousGamepad=null,this.isDisabled()?this.setupDisabledRunner():(Runner.isAltGameModeEnabled()&&(this.initAltGameType(),Runner.gameType=this.gameType),this.loadImages(),window.initializeEasterEggHighScore=this.initializeHighScore.bind(this))}initAltGameType(){0<GAME_TYPE.length&&(this.gameType=loadTimeData&&loadTimeData.valueExists("altGameType")?GAME_TYPE[parseInt(loadTimeData.getValue("altGameType"),10)-1]:"")}isDisabled(){return loadTimeData&&loadTimeData.valueExists("disabledEasterEgg")}setupDisabledRunner(){this.containerEl=document.createElement("div"),this.containerEl.className=Runner.classes.SNACKBAR,this.containerEl.textContent=loadTimeData.getValue("disabledEasterEgg"),this.outerContainerEl.appendChild(this.containerEl),document.addEventListener(Runner.events.KEYDOWN,e=>{Runner.keycodes.JUMP[e.keyCode]&&(this.containerEl.classList.add(Runner.classes.SNACKBAR_SHOW),document.querySelector(".icon").classList.add("icon-disabled"))})}updateConfigSetting(setting,value){if(setting in this.config&&void 0!==value)switch(this.config[setting]=value,setting){case"GRAVITY":case"MIN_JUMP_HEIGHT":case"SPEED_DROP_COEFFICIENT":this.tRex.config[setting]=value;break;case"INITIAL_JUMP_VELOCITY":this.tRex.setJumpVelocity(value);break;case"SPEED":this.setSpeed(value)}}createImageElement(resourceName){var el,imgSrc=loadTimeData&&loadTimeData.valueExists(resourceName)?loadTimeData.getString(resourceName):null;return imgSrc?((el=document.createElement("img")).id=resourceName,el.src=imgSrc,document.getElementById("offline-resources").appendChild(el),el):null}loadImages(){let scale="1x";this.spriteDef=Runner.spriteDefinition.LDPI,IS_HIDPI&&(scale="2x",this.spriteDef=Runner.spriteDefinition.HDPI),Runner.imageSprite=document.getElementById(RESOURCE_POSTFIX+scale),this.gameType&&(Runner.altGameImageSprite=this.createImageElement("altGameSpecificImage"+scale),Runner.altCommonImageSprite=this.createImageElement("altGameCommonImage"+scale)),Runner.origImageSprite=Runner.imageSprite,Runner.altGameImageSprite&&Runner.altCommonImageSprite||(Runner.isAltGameModeEnabled=()=>!1,this.altGameModeActive=!1),Runner.imageSprite.complete?this.init():Runner.imageSprite.addEventListener(Runner.events.LOAD,this.init.bind(this))}loadSounds(){if(!IS_IOS){this.audioContext=new AudioContext;var sound,resourceTemplate=document.getElementById(this.config.RESOURCE_TEMPLATE_ID).content;for(sound in Runner.sounds){let soundSrc=resourceTemplate.getElementById(Runner.sounds[sound]).src;var buffer=decodeBase64ToArrayBuffer(soundSrc=soundSrc.substr(soundSrc.indexOf(",")+1));this.audioContext.decodeAudioData(buffer,function(index,audioData){this.soundFx[index]=audioData}.bind(this,sound))}}}setSpeed(opt_speed){var mobileSpeed,speed=opt_speed||this.currentSpeed;this.dimensions.WIDTH<DEFAULT_WIDTH?(mobileSpeed=Runner.slowDown?speed:speed*this.dimensions.WIDTH/DEFAULT_WIDTH*this.config.MOBILE_SPEED_COEFFICIENT,this.currentSpeed=speed<mobileSpeed?speed:mobileSpeed):opt_speed&&(this.currentSpeed=opt_speed)}init(){window.Runner=Runner,this.isArcadeMode()&&(document.title=document.title+" - "+getA11yString(A11Y_STRINGS.ariaLabel)),this.adjustDimensions(),this.setSpeed();var ariaLabel=getA11yString(A11Y_STRINGS.ariaLabel),ariaLabel=(this.containerEl=document.createElement("div"),this.containerEl.setAttribute("role",IS_MOBILE?"button":"application"),this.containerEl.setAttribute("tabindex","0"),this.containerEl.setAttribute("title",getA11yString(A11Y_STRINGS.description)),this.containerEl.setAttribute("aria-label",ariaLabel),this.containerEl.className=Runner.classes.CONTAINER,this.canvas=createCanvas(this.containerEl,this.dimensions.WIDTH,this.dimensions.HEIGHT),this.a11yStatusEl=document.createElement("span"),this.a11yStatusEl.className="offline-runner-live-region",this.a11yStatusEl.setAttribute("aria-live","assertive"),this.a11yStatusEl.textContent="",Runner.a11yStatusEl=this.a11yStatusEl,this.slowSpeedCheckboxLabel=document.createElement("label"),this.slowSpeedCheckboxLabel.className="slow-speed-option hidden",this.slowSpeedCheckboxLabel.textContent=getA11yString(A11Y_STRINGS.speedLabel),this.slowSpeedCheckbox=document.createElement("input"),this.slowSpeedCheckbox.setAttribute("type","checkbox"),this.slowSpeedCheckbox.setAttribute("title",getA11yString(A11Y_STRINGS.speedLabel)),this.slowSpeedCheckbox.setAttribute("tabindex","0"),this.slowSpeedCheckbox.setAttribute("checked","checked"),this.slowSpeedToggleEl=document.createElement("span"),this.slowSpeedToggleEl.className="slow-speed-toggle",this.slowSpeedCheckboxLabel.appendChild(this.slowSpeedCheckbox),this.slowSpeedCheckboxLabel.appendChild(this.slowSpeedToggleEl),(IS_IOS?this.outerContainerEl:this.containerEl).appendChild(this.a11yStatusEl),this.generatedSoundFx=new GeneratedSoundFx,this.canvasCtx=this.canvas.getContext("2d"),this.canvasCtx.fillStyle="#f7f7f7",this.canvasCtx.fill(),Runner.updateCanvasScaling(this.canvas),this.horizon=new Horizon(this.canvas,this.spriteDef,this.dimensions,this.config.GAP_COEFFICIENT),this.distanceMeter=new DistanceMeter(this.canvas,this.spriteDef.TEXT_SPRITE,this.dimensions.WIDTH),this.tRex=new Trex(this.canvas,this.spriteDef.TREX),this.outerContainerEl.appendChild(this.containerEl),this.startListening(),this.update(),window.addEventListener(Runner.events.RESIZE,this.debounceResize.bind(this)),window.matchMedia("(prefers-color-scheme: dark)"));this.isDarkMode=ariaLabel&&ariaLabel.matches,ariaLabel.addEventListener("change",e=>{this.isDarkMode=e.matches})}createTouchController(){this.touchController=document.createElement("div"),this.touchController.className=Runner.classes.TOUCH_CONTROLLER,this.touchController.addEventListener(Runner.events.TOUCHSTART,this),this.touchController.addEventListener(Runner.events.TOUCHEND,this),this.outerContainerEl.appendChild(this.touchController)}debounceResize(){this.resizeTimerId_||(this.resizeTimerId_=setInterval(this.adjustDimensions.bind(this),250))}adjustDimensions(){clearInterval(this.resizeTimerId_),this.resizeTimerId_=null;var boxStyles=window.getComputedStyle(this.outerContainerEl),boxStyles=Number(boxStyles.paddingLeft.substr(0,boxStyles.paddingLeft.length-2));this.dimensions.WIDTH=this.outerContainerEl.offsetWidth-2*boxStyles,this.isArcadeMode()&&(this.dimensions.WIDTH=Math.min(DEFAULT_WIDTH,this.dimensions.WIDTH),this.activated)&&this.setArcadeModeContainerScale(),this.canvas&&(this.canvas.width=this.dimensions.WIDTH,this.canvas.height=this.dimensions.HEIGHT,Runner.updateCanvasScaling(this.canvas),this.distanceMeter.calcXPos(this.dimensions.WIDTH),this.clearCanvas(),this.horizon.update(0,0,!0),this.tRex.update(0),this.playing||this.crashed||this.paused?(this.containerEl.style.width=this.dimensions.WIDTH+"px",this.containerEl.style.height=this.dimensions.HEIGHT+"px",this.distanceMeter.update(0,Math.ceil(this.distanceRan)),this.stop()):this.tRex.draw(0,0),this.crashed)&&this.gameOverPanel&&(this.gameOverPanel.updateDimensions(this.dimensions.WIDTH),this.gameOverPanel.draw(this.altGameModeActive,this.tRex))}playIntro(){var keyframes;this.activated||this.crashed?this.crashed&&this.restart():(this.playingIntro=!0,this.tRex.playingIntro=!0,keyframes="@-webkit-keyframes intro { "+`from { width:${Trex.config.WIDTH}px }`+`to { width: ${this.dimensions.WIDTH}px }`+"}",document.styleSheets[0].insertRule(keyframes,0),this.containerEl.addEventListener(Runner.events.ANIM_END,this.startGame.bind(this)),this.containerEl.style.webkitAnimation="intro .4s ease-out 1 both",this.containerEl.style.width=this.dimensions.WIDTH+"px",this.setPlayStatus(!0),this.activated=!0)}startGame(){this.isArcadeMode()&&this.setArcadeMode(),this.toggleSpeed(),this.runningTime=0,this.playingIntro=!1,this.tRex.playingIntro=!1,this.containerEl.style.webkitAnimation="",this.playCount++,this.generatedSoundFx.background(),Runner.audioCues&&this.containerEl.setAttribute("title",getA11yString(A11Y_STRINGS.jump)),document.addEventListener(Runner.events.VISIBILITY,this.onVisibilityChange.bind(this)),window.addEventListener(Runner.events.BLUR,this.onVisibilityChange.bind(this)),window.addEventListener(Runner.events.FOCUS,this.onVisibilityChange.bind(this))}clearCanvas(){this.canvasCtx.clearRect(0,0,this.dimensions.WIDTH,this.dimensions.HEIGHT)}isCanvasInView(){return this.containerEl.getBoundingClientRect().top>Runner.config.CANVAS_IN_VIEW_OFFSET}enableAltGameMode(){Runner.imageSprite=Runner.altGameImageSprite,Runner.spriteDefinition=spriteDefinitionByType[Runner.gameType],this.spriteDef=IS_HIDPI?Runner.spriteDefinition.HDPI:Runner.spriteDefinition.LDPI,this.altGameModeActive=!0,this.tRex.enableAltGameMode(this.spriteDef.TREX),this.horizon.enableAltGameMode(this.spriteDef),this.generatedSoundFx.background()}update(){this.updatePending=!1;var now=getTimeStamp();let deltaTime=now-(this.time||now);if(this.altGameModeFlashTimer<0||0===this.altGameModeFlashTimer?(this.altGameModeFlashTimer=null,this.tRex.setFlashing(!1),this.enableAltGameMode()):0<this.altGameModeFlashTimer&&(this.altGameModeFlashTimer-=deltaTime,this.tRex.update(deltaTime),deltaTime=0),this.time=now,this.playing){this.clearCanvas(),this.altGameModeActive&&this.fadeInTimer<=this.config.FADE_DURATION?(this.fadeInTimer+=deltaTime/1e3,this.canvasCtx.globalAlpha=this.fadeInTimer):this.canvasCtx.globalAlpha=1,this.tRex.jumping&&this.tRex.updateJump(deltaTime),this.runningTime+=deltaTime;var now=this.runningTime>this.config.CLEAR_TIME;1!==this.tRex.jumpCount||this.playingIntro||this.playIntro(),this.playingIntro?this.horizon.update(0,this.currentSpeed,now):this.crashed||(showNightMode=this.isDarkMode^this.inverted,deltaTime=this.activated?deltaTime:0,this.horizon.update(deltaTime,this.currentSpeed,now,showNightMode));let collision=now&&checkForCollision(this.horizon.obstacles[0],this.tRex);Runner.audioCues&&now&&(showNightMode="COLLECTABLE"!==this.horizon.obstacles[0].typeConfig.type,this.horizon.obstacles[0].jumpAlerted||(now=(now=Runner.isMobileMouseInput?Runner.config.AUDIOCUE_PROXIMITY_THRESHOLD_MOBILE_A11Y:Runner.config.AUDIOCUE_PROXIMITY_THRESHOLD)+now*Math.log10(this.currentSpeed/Runner.config.SPEED),this.horizon.obstacles[0].xPos<now&&(showNightMode&&this.generatedSoundFx.jump(),this.horizon.obstacles[0].jumpAlerted=!0))),Runner.isAltGameModeEnabled()&&collision&&"COLLECTABLE"===this.horizon.obstacles[0].typeConfig.type&&(this.horizon.removeFirstObstacle(),this.tRex.setFlashing(!0),collision=!1,this.altGameModeFlashTimer=this.config.FLASH_DURATION,this.runningTime=0,this.generatedSoundFx.collect()),collision?this.gameOver():(this.distanceRan+=this.currentSpeed*deltaTime/this.msPerFrame,this.currentSpeed<this.config.MAX_SPEED&&(this.currentSpeed+=this.config.ACCELERATION));var showNightMode,now=this.distanceMeter.update(deltaTime,Math.ceil(this.distanceRan));!Runner.audioCues&&now&&this.playSound(this.soundFx.SCORE),Runner.isAltGameModeEnabled()||(this.invertTimer>this.config.INVERT_FADE_DURATION?(this.invertTimer=0,this.invertTrigger=!1,this.invert(!1)):this.invertTimer?this.invertTimer+=deltaTime:0<(showNightMode=this.distanceMeter.getActualDistance(Math.ceil(this.distanceRan)))&&(this.invertTrigger=!(showNightMode%this.config.INVERT_DISTANCE),this.invertTrigger)&&0===this.invertTimer&&(this.invertTimer+=deltaTime,this.invert(!1)))}(this.playing||!this.activated&&this.tRex.blinkCount<Runner.config.MAX_BLINK_COUNT)&&(this.tRex.update(deltaTime),this.scheduleNextUpdate())}handleEvent(e){return function(evtType,events){switch(evtType){case events.KEYDOWN:case events.TOUCHSTART:case events.POINTERDOWN:this.onKeyDown(e);break;case events.KEYUP:case events.TOUCHEND:case events.POINTERUP:this.onKeyUp(e);break;case events.GAMEPADCONNECTED:this.onGamepadConnected(e)}}.bind(this)(e.type,Runner.events)}handleCanvasKeyPress(e){this.activated||Runner.audioCues?e.keyCode&&Runner.keycodes.JUMP[e.keyCode]&&this.onKeyDown(e):(this.toggleSpeed(),Runner.audioCues=!0,this.generatedSoundFx.init(),Runner.generatedSoundFx=this.generatedSoundFx,Runner.config.CLEAR_TIME*=1.2)}preventScrolling(e){32===e.keyCode&&e.preventDefault()}toggleSpeed(){var updatedConfig;Runner.audioCues&&(Runner.slowDown!==this.slowSpeedCheckbox.checked&&(Runner.slowDown=this.slowSpeedCheckbox.checked,updatedConfig=Runner.slowDown?Runner.slowConfig:Runner.normalConfig,Runner.config=Object.assign(Runner.config,updatedConfig),this.currentSpeed=updatedConfig.SPEED,this.tRex.enableSlowConfig(),this.horizon.adjustObstacleSpeed()),this.playing)&&this.disableSpeedToggle(!0)}showSpeedToggle(e){e=e&&"focus"===e.type;(Runner.audioCues||e)&&this.slowSpeedCheckboxLabel.classList.toggle(HIDDEN_CLASS,!e&&!this.crashed)}disableSpeedToggle(disable){disable?this.slowSpeedCheckbox.setAttribute("disabled","disabled"):this.slowSpeedCheckbox.removeAttribute("disabled")}startListening(){this.containerEl.addEventListener(Runner.events.KEYDOWN,this.handleCanvasKeyPress.bind(this)),IS_MOBILE||this.containerEl.addEventListener(Runner.events.FOCUS,this.showSpeedToggle.bind(this)),this.canvas.addEventListener(Runner.events.KEYDOWN,this.preventScrolling.bind(this)),this.canvas.addEventListener(Runner.events.KEYUP,this.preventScrolling.bind(this)),document.addEventListener(Runner.events.KEYDOWN,this),document.addEventListener(Runner.events.KEYUP,this),this.containerEl.addEventListener(Runner.events.TOUCHSTART,this),document.addEventListener(Runner.events.POINTERDOWN,this),document.addEventListener(Runner.events.POINTERUP,this),this.isArcadeMode()&&window.addEventListener(Runner.events.GAMEPADCONNECTED,this)}stopListening(){document.removeEventListener(Runner.events.KEYDOWN,this),document.removeEventListener(Runner.events.KEYUP,this),this.touchController&&(this.touchController.removeEventListener(Runner.events.TOUCHSTART,this),this.touchController.removeEventListener(Runner.events.TOUCHEND,this)),this.containerEl.removeEventListener(Runner.events.TOUCHSTART,this),document.removeEventListener(Runner.events.POINTERDOWN,this),document.removeEventListener(Runner.events.POINTERUP,this),this.isArcadeMode()&&window.removeEventListener(Runner.events.GAMEPADCONNECTED,this)}onKeyDown(e){var isMobileMouseInput;IS_MOBILE&&this.playing&&e.preventDefault(),!this.isCanvasInView()||Runner.keycodes.JUMP[e.keyCode]&&e.target===this.slowSpeedCheckbox||this.crashed||this.paused||(isMobileMouseInput=IS_MOBILE&&e.type===Runner.events.POINTERDOWN&&"mouse"===e.pointerType&&(e.target===this.containerEl||IS_IOS&&(e.target===this.touchController||e.target===this.canvas)),Runner.keycodes.JUMP[e.keyCode]||e.type===Runner.events.TOUCHSTART||isMobileMouseInput?(e.preventDefault(),this.playing||(this.touchController||e.type!==Runner.events.TOUCHSTART||this.createTouchController(),isMobileMouseInput&&this.handleCanvasKeyPress(e),this.loadSounds(),this.setPlayStatus(!0),this.update(),window.errorPageController&&errorPageController.trackEasterEgg()),this.tRex.jumping||this.tRex.ducking||(Runner.audioCues?this.generatedSoundFx.cancelFootSteps():this.playSound(this.soundFx.BUTTON_PRESS),this.tRex.startJump(this.currentSpeed))):this.playing&&Runner.keycodes.DUCK[e.keyCode]&&(e.preventDefault(),this.tRex.jumping?this.tRex.setSpeedDrop():(this.tRex.jumping,this.tRex.ducking||this.tRex.setDuck(!0))))}onKeyUp(e){var deltaTime,keyCode=String(e.keyCode),isjumpKey=Runner.keycodes.JUMP[keyCode]||e.type===Runner.events.TOUCHEND||e.type===Runner.events.POINTERUP;this.isRunning()&&isjumpKey?this.tRex.endJump():Runner.keycodes.DUCK[keyCode]?(this.tRex.speedDrop=!1,this.tRex.setDuck(!1)):this.crashed?(deltaTime=getTimeStamp()-this.time,this.isCanvasInView()&&(Runner.keycodes.RESTART[keyCode]||this.isLeftClickOnCanvas(e)||deltaTime>=this.config.GAMEOVER_CLEAR_TIME&&Runner.keycodes.JUMP[keyCode])&&this.handleGameOverClicks(e)):this.paused&&isjumpKey&&(this.tRex.reset(),this.play())}onGamepadConnected(e){this.pollingGamepads||this.pollGamepadState()}pollGamepadState(){var gamepads=navigator.getGamepads();this.pollActiveGamepad(gamepads),this.pollingGamepads=!0,requestAnimationFrame(this.pollGamepadState.bind(this))}pollForActiveGamepad(gamepads){for(let i=0;i<gamepads.length;++i)if(gamepads[i]&&0<gamepads[i].buttons.length&&gamepads[i].buttons[0].pressed)return this.gamepadIndex=i,void this.pollActiveGamepad(gamepads)}pollActiveGamepad(gamepads){var gamepad;void 0===this.gamepadIndex?this.pollForActiveGamepad(gamepads):(gamepad=gamepads[this.gamepadIndex])?(this.pollGamepadButton(gamepad,0,38),2<=gamepad.buttons.length&&this.pollGamepadButton(gamepad,1,40),10<=gamepad.buttons.length&&this.pollGamepadButton(gamepad,9,13),this.previousGamepad=gamepad):(this.gamepadIndex=void 0,this.pollForActiveGamepad(gamepads))}pollGamepadButton(gamepad,buttonIndex,keyCode){gamepad=gamepad.buttons[buttonIndex].pressed;let previousState=!1;gamepad!==(previousState=this.previousGamepad?this.previousGamepad.buttons[buttonIndex].pressed:previousState)&&(buttonIndex=new KeyboardEvent(gamepad?Runner.events.KEYDOWN:Runner.events.KEYUP,{keyCode:keyCode}),document.dispatchEvent(buttonIndex))}handleGameOverClicks(e){e.target!==this.slowSpeedCheckbox&&(e.preventDefault(),this.distanceMeter.hasClickedOnHighScore(e)&&this.highestScore?this.distanceMeter.isHighScoreFlashing()?(this.saveHighScore(0,!0),this.distanceMeter.resetHighScore()):this.distanceMeter.startHighScoreFlashing():(this.distanceMeter.cancelHighScoreFlashing(),this.restart()))}isLeftClickOnCanvas(e){return null!=e.button&&e.button<2&&e.type===Runner.events.POINTERUP&&(e.target===this.canvas||IS_MOBILE&&Runner.audioCues&&e.target===this.containerEl)}scheduleNextUpdate(){this.updatePending||(this.updatePending=!0,this.raqId=requestAnimationFrame(this.update.bind(this)))}isRunning(){return!!this.raqId}initializeHighScore(highScore){this.syncHighestScore=!0,(highScore=Math.ceil(highScore))<this.highestScore?window.errorPageController&&errorPageController.updateEasterEggHighScore(this.highestScore):(this.highestScore=highScore,this.distanceMeter.setHighScore(this.highestScore))}saveHighScore(distanceRan,opt_resetScore){this.highestScore=Math.ceil(distanceRan),this.distanceMeter.setHighScore(this.highestScore),this.syncHighestScore&&window.errorPageController&&(opt_resetScore?errorPageController.resetEasterEggHighScore():errorPageController.updateEasterEggHighScore(this.highestScore))}gameOver(){var origSpriteDef;this.playSound(this.soundFx.HIT),vibrate(200),this.stop(),this.crashed=!0,this.distanceMeter.achievement=!1,this.tRex.update(100,Trex.status.CRASHED),this.gameOverPanel||(origSpriteDef=IS_HIDPI?spriteDefinitionByType.original.HDPI:spriteDefinitionByType.original.LDPI,this.canvas&&(Runner.isAltGameModeEnabled?this.gameOverPanel=new GameOverPanel(this.canvas,origSpriteDef.TEXT_SPRITE,origSpriteDef.RESTART,this.dimensions,origSpriteDef.ALT_GAME_END,this.altGameModeActive):this.gameOverPanel=new GameOverPanel(this.canvas,origSpriteDef.TEXT_SPRITE,origSpriteDef.RESTART,this.dimensions))),this.gameOverPanel.draw(this.altGameModeActive,this.tRex),this.distanceRan>this.highestScore&&this.saveHighScore(this.distanceRan),this.time=getTimeStamp(),Runner.audioCues&&(this.generatedSoundFx.stopAll(),announcePhrase(getA11yString(A11Y_STRINGS.gameOver).replace("$1",this.distanceMeter.getActualDistance(this.distanceRan).toString())+" "+getA11yString(A11Y_STRINGS.highScore).replace("$1",this.distanceMeter.getActualDistance(this.highestScore).toString())),this.containerEl.setAttribute("title",getA11yString(A11Y_STRINGS.ariaLabel))),this.showSpeedToggle(),this.disableSpeedToggle(!1)}stop(){this.setPlayStatus(!1),this.paused=!0,cancelAnimationFrame(this.raqId),this.raqId=0,this.generatedSoundFx.stopAll()}play(){this.crashed||(this.setPlayStatus(!0),this.paused=!1,this.tRex.update(0,Trex.status.RUNNING),this.time=getTimeStamp(),this.update(),this.generatedSoundFx.background())}restart(){this.raqId||(this.playCount++,this.runningTime=0,this.setPlayStatus(!0),this.toggleSpeed(),this.paused=!1,this.crashed=!1,this.distanceRan=0,this.setSpeed(this.config.SPEED),this.time=getTimeStamp(),this.containerEl.classList.remove(Runner.classes.CRASHED),this.clearCanvas(),this.distanceMeter.reset(),this.horizon.reset(),this.tRex.reset(),this.playSound(this.soundFx.BUTTON_PRESS),this.invert(!0),this.flashTimer=null,this.update(),this.gameOverPanel.reset(),this.generatedSoundFx.background(),this.containerEl.setAttribute("title",getA11yString(A11Y_STRINGS.jump)),announcePhrase(getA11yString(A11Y_STRINGS.started)))}setPlayStatus(isPlaying){this.touchController&&this.touchController.classList.toggle(HIDDEN_CLASS,!isPlaying),this.playing=isPlaying}isArcadeMode(){return IS_RTL?1===document.title.indexOf(ARCADE_MODE_URL):document.title===ARCADE_MODE_URL}setArcadeMode(){document.body.classList.add(Runner.classes.ARCADE_MODE),this.setArcadeModeContainerScale()}setArcadeModeContainerScale(){var windowHeight=window.innerHeight,scaleHeight=windowHeight/this.dimensions.HEIGHT,scaleWidth=window.innerWidth/this.dimensions.WIDTH,scaleHeight=Math.max(1,Math.min(scaleHeight,scaleWidth)),scaleWidth=this.dimensions.HEIGHT*scaleHeight,windowHeight=Math.ceil(Math.max(0,(windowHeight-scaleWidth-Runner.config.ARCADE_MODE_INITIAL_TOP_POSITION)*Runner.config.ARCADE_MODE_TOP_POSITION_PERCENT))*window.devicePixelRatio;this.containerEl.style.transform=`scale(${IS_RTL?-scaleHeight+","+scaleHeight:scaleHeight}) translateY(${windowHeight}px)`}onVisibilityChange(e){document.hidden||document.webkitHidden||"blur"===e.type||"visible"!==document.visibilityState?this.stop():this.crashed||(this.tRex.reset(),this.play())}playSound(soundBuffer){var sourceNode;soundBuffer&&((sourceNode=this.audioContext.createBufferSource()).buffer=soundBuffer,sourceNode.connect(this.audioContext.destination),sourceNode.start(0))}invert(reset){var htmlEl=document.firstElementChild;reset?(htmlEl.classList.toggle(Runner.classes.INVERTED,!1),this.invertTimer=0,this.inverted=!1):this.inverted=htmlEl.classList.toggle(Runner.classes.INVERTED,this.invertTrigger)}destroy(){this.stop(),this.stopListening(),this.containerEl.remove()}}function speakPhrase(phrase){var msg;"speechSynthesis"in window&&(msg=new SpeechSynthesisUtterance(phrase),window.speechSynthesis.getVoices(),msg.text=phrase,speechSynthesis.speak(msg))}function announcePhrase(phrase){Runner.a11yStatusEl&&(Runner.a11yStatusEl.textContent="",Runner.a11yStatusEl.textContent=phrase)}function getA11yString(stringName){return loadTimeData&&loadTimeData.valueExists(stringName)?loadTimeData.getString(stringName):""}function vibrate(duration){IS_MOBILE&&window.navigator.vibrate&&window.navigator.vibrate(duration)}function createCanvas(container,width,height,opt_classname){var canvas=document.createElement("canvas");return canvas.className=opt_classname?Runner.classes.CANVAS+" "+opt_classname:Runner.classes.CANVAS,canvas.width=width,canvas.height=height,container.appendChild(canvas),canvas}function decodeBase64ToArrayBuffer(base64String){var len=base64String.length/4*3,str=atob(base64String),base64String=new ArrayBuffer(len),bytes=new Uint8Array(base64String);for(let i=0;i<len;i++)bytes[i]=str.charCodeAt(i);return bytes.buffer}function checkForCollision(obstacle,tRex,opt_canvasCtx){Runner.defaultDimensions.WIDTH,obstacle.xPos;var tRexBox=new CollisionBox(tRex.xPos+1,tRex.yPos+1,tRex.config.WIDTH-2,tRex.config.HEIGHT-2),obstacleBox=new CollisionBox(obstacle.xPos+1,obstacle.yPos+1,obstacle.typeConfig.width*obstacle.size-2,obstacle.typeConfig.height-2);if(opt_canvasCtx&&drawCollisionBoxes(opt_canvasCtx,tRexBox,obstacleBox),boxCompare(tRexBox,obstacleBox)){var collisionBoxes=obstacle.collisionBoxes;let tRexCollisionBoxes=[];tRexCollisionBoxes=Runner.isAltGameModeEnabled()?Runner.spriteDefinition.TREX.COLLISION_BOXES:tRex.ducking?Trex.collisionBoxes.DUCKING:Trex.collisionBoxes.RUNNING;for(let t=0;t<tRexCollisionBoxes.length;t++)for(let i=0;i<collisionBoxes.length;i++){var adjTrexBox=createAdjustedCollisionBox(tRexCollisionBoxes[t],tRexBox),adjObstacleBox=createAdjustedCollisionBox(collisionBoxes[i],obstacleBox),crashed=boxCompare(adjTrexBox,adjObstacleBox);if(opt_canvasCtx&&drawCollisionBoxes(opt_canvasCtx,adjTrexBox,adjObstacleBox),crashed)return[adjTrexBox,adjObstacleBox]}}}function createAdjustedCollisionBox(box,adjustment){return new CollisionBox(box.x+adjustment.x,box.y+adjustment.y,box.width,box.height)}function drawCollisionBoxes(canvasCtx,tRexBox,obstacleBox){canvasCtx.save(),canvasCtx.strokeStyle="#f00",canvasCtx.strokeRect(tRexBox.x,tRexBox.y,tRexBox.width,tRexBox.height),canvasCtx.strokeStyle="#0f0",canvasCtx.strokeRect(obstacleBox.x,obstacleBox.y,obstacleBox.width,obstacleBox.height),canvasCtx.restore()}function boxCompare(tRexBox,obstacleBox){let crashed=!1;tRexBox.x;var obstacleBoxX=obstacleBox.x;return crashed=tRexBox.x<obstacleBoxX+obstacleBox.width&&tRexBox.x+tRexBox.width>obstacleBoxX&&tRexBox.y<obstacleBox.y+obstacleBox.height&&tRexBox.height+tRexBox.y>obstacleBox.y?!0:crashed}Runner.prototype.playSound=function(){};export{Runner};